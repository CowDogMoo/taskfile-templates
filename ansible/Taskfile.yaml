---
version: "3"

tasks:
  changelog-lint:
    desc: "Lint the changelog"
    cmds:
      - antsibull-changelog lint

  changelog-release:
    desc: "Generate the changelog release"
    deps: [update-galaxy-version]
    cmds:
      - antsibull-changelog release --version $NEXT_VERSION

  gen-changelog:
    desc: "Generate the changelog for the next release"
    cmds:
      - |
        if [ -z "$NEXT_VERSION" ]; then
          echo "'NEXT_VERSION' environment variable not set. Example: NEXT_VERSION=1.0.0"
          exit 1
        fi
      - echo "Generating changelog for release $NEXT_VERSION"
      - task: changelog-lint
      - task: changelog-release

  lint-ansible:
    desc: "Run Ansible Lint"
    cmds:
      - |
        echo "Running ansible-lint."
        ansible-lint --force-color -c .hooks/linters/ansible-lint.yaml
    silent: true

  ping:
    desc: "Ping: cross-OS, works on all/group/pattern/host specification, robust. Auto-detects Windows and Linux hosts."
    vars:
      INVENTORY: '{{.INVENTORY}}'
      HOSTS:     '{{.HOSTS | default "all"}}'
      DEBUG:     '{{.DEBUG | default "false"}}'
      OS_TYPE:   '{{.OS_TYPE | default "auto"}}'
    cmds:
      - |
        # Explicit OS_TYPE shortcuts
        if [ "{{.OS_TYPE}}" = "windows" ]; then
          echo "Using win_ping module for all hosts (OS_TYPE=windows)"
          {{if eq .DEBUG "false"}}ANSIBLE_PYTHON_INTERPRETER=auto_silent {{end}}\
            ansible {{.HOSTS}} -i "{{.INVENTORY}}" -m win_ping
          exit $?
        elif [ "{{.OS_TYPE}}" = "linux" ]; then
          echo "Using ping module for all hosts (OS_TYPE=linux)"
          {{if eq .DEBUG "false"}}ANSIBLE_PYTHON_INTERPRETER=auto_silent {{end}}\
            ansible {{.HOSTS}} -i "{{.INVENTORY}}" -m ping
          exit $?
        fi

        # Auto-detect & ping once per host via an inline playbook
        echo "Auto-detecting host types and pinging each hostâ€¦"

        PLAYBOOK_FILE=$(mktemp /tmp/ping_playbook.XXXXXX.yml)
        cat > "$PLAYBOOK_FILE" <<'EOF'
        ---
        - hosts: {{.HOSTS}}
          gather_facts: yes
          tasks:
            - name: Ping Linux hosts
              ping:
              when: ansible_facts.os_family != 'Windows'

            - name: Ping Windows hosts
              win_ping:
              when: ansible_facts.os_family == 'Windows'
        EOF

        echo "===== PING RESULTS ====="
        {{if eq .DEBUG "false"}}ANSIBLE_PYTHON_INTERPRETER=auto_silent {{end}}\
          ansible-playbook -i "{{.INVENTORY}}" "$PLAYBOOK_FILE"
        RET=$?

        rm -f "$PLAYBOOK_FILE"
        exit $RET
    silent: false

  run-molecule-tests:
    desc: "Run Molecule tests for all roles"
    cmds:
      - |
        mkdir -p logs
        export ANSIBLE_CONFIG=$(pwd)/ansible.cfg
        for role in roles/*; do
          if [[ -d "$role" ]]; then
            echo "Running molecule tests for role $role"
            (cd "$role" && molecule test) | tee -a logs/molecule_tests.log || exit 1
          fi
        done
    silent: true

  update-galaxy-version:
    desc: "Update version in galaxy.yml if it exists"
    cmds:
      - |
        if [ -z "$NEXT_VERSION" ]; then
          echo "'NEXT_VERSION' environment variable not set."
          exit 1
        fi
        if [ -f "galaxy.yml" ]; then
          yq e -i '.version = env(NEXT_VERSION)' galaxy.yml
          echo "Updated galaxy.yml version to $NEXT_VERSION"
        else
          echo "No galaxy.yml found, skipping version update"
        fi
    silent: true
