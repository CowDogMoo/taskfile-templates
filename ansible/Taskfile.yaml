---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

set: [pipefail]

vars:
  COLLECTION_PATH:
    sh: echo "${COLLECTION_PATH:-$HOME/.ansible/collections}"
  TARBALL:
    sh: ls -t *.tar.gz 2>/dev/null | head -n1 || echo ""

tasks:
  build-collection:
    desc: Build Ansible collection artifact with cleanup
    vars:
      BUILD_DIR: '{{.BUILD_DIR | default "."}}'
    preconditions:
      - sh: test -f galaxy.yml
        msg: "galaxy.yml not found. Are you in a collection directory?"
    cmds:
      - rm -f *.tar.gz
      - |
        if [ -d "roles" ]; then
          find roles -type d -name ".ansible" -exec rm -rf {} + 2>/dev/null || true
        fi
      - ansible-galaxy collection build --force --output-path {{.BUILD_DIR}}
    sources:
      - galaxy.yml
      - roles/**/*
      - plugins/**/*
      - meta/**/*
    generates:
      - "*.tar.gz"

  install-collection:
    desc: Install Ansible collection from tarball
    vars:
      COLLECTION_PATH: '{{.COLLECTION_PATH | default .COLLECTION_PATH}}'
      TARBALL: '{{.TARBALL | default .TARBALL}}'
    preconditions:
      - sh: '[ -n "{{.TARBALL}}" ]'
        msg: "No tarball found. Run 'task ansible:build-collection' first or specify TARBALL=path"
    cmds:
      - ansible-galaxy collection install {{.TARBALL}} --force --collections-path {{.COLLECTION_PATH}}

  build-install-collection:
    desc: Build and install collection (recommended for development)
    vars:
      COLLECTION_PATH: '{{.COLLECTION_PATH | default .COLLECTION_PATH}}'
      INSTALL_GLOBAL: '{{.INSTALL_GLOBAL | default "false"}}'
      KEEP_TARBALL: '{{.KEEP_TARBALL | default "false"}}'
    preconditions:
      - sh: test -f galaxy.yml
        msg: "galaxy.yml not found. Are you in a collection directory?"
    cmds:
      - rm -f *.tar.gz
      - |
        if [ -d "roles" ]; then
          find roles -type d -name ".ansible" -exec rm -rf {} + 2>/dev/null || true
        fi
      - ansible-galaxy collection build --force
      - defer: '[ "{{.KEEP_TARBALL}}" = "true" ] || rm -f *.tar.gz'
      - |
        TARBALL=$(ls -t *.tar.gz 2>/dev/null | head -n1)
        ansible-galaxy collection install "$TARBALL" --force --collections-path {{.COLLECTION_PATH}}
        if [ "{{.INSTALL_GLOBAL}}" = "true" ]; then
          ansible-galaxy collection install "$TARBALL" --force --collections-path ~/.ansible/collections
        fi

  uninstall-collection:
    desc: Uninstall Ansible collection
    vars:
      NAMESPACE: '{{.NAMESPACE}}'
      COLLECTION: '{{.COLLECTION}}'
      COLLECTION_PATH: '{{.COLLECTION_PATH | default .COLLECTION_PATH}}'
    preconditions:
      - sh: '[ -n "{{.NAMESPACE}}" ]'
        msg: "NAMESPACE required. Usage: task ansible:uninstall-collection NAMESPACE=cowdogmoo COLLECTION=workstation"
      - sh: '[ -n "{{.COLLECTION}}" ]'
        msg: "COLLECTION required. Usage: task ansible:uninstall-collection NAMESPACE=cowdogmoo COLLECTION=workstation"
      - sh: test -d {{.COLLECTION_PATH}}/ansible_collections/{{.NAMESPACE}}/{{.COLLECTION}}
        msg: "Collection not found at {{.COLLECTION_PATH}}/ansible_collections/{{.NAMESPACE}}/{{.COLLECTION}}"
    cmds:
      - rm -rf {{.COLLECTION_PATH}}/ansible_collections/{{.NAMESPACE}}/{{.COLLECTION}}

  changelog-lint:
    desc: Lint the changelog
    cmds:
      - antsibull-changelog lint
    silent: true

  changelog-release:
    desc: Generate the changelog release
    deps: [update-galaxy-version]
    cmds:
      - antsibull-changelog release --version $NEXT_VERSION

  check-ansible:
    desc: Validate that Ansible is installed
    preconditions:
      - sh: command -v ansible
        msg: "ansible not found. Install from https://docs.ansible.com/ansible/latest/installation_guide/"
    silent: true

  gen-changelog:
    desc: Generate the changelog for the next release
    preconditions:
      - sh: '[ -n "$NEXT_VERSION" ]'
        msg: "NEXT_VERSION environment variable not set. Example: NEXT_VERSION=1.0.0"
    cmds:
      - task: changelog-lint
      - task: changelog-release

  lint-ansible:
    desc: Run Ansible Lint
    cmds:
      - ansible-lint --force-color -c .hooks/linters/ansible-lint.yaml

  ping:
    desc: Ping hosts (auto-detects Windows, Linux, macOS)
    vars:
      INVENTORY: '{{.INVENTORY}}'
      HOSTS: '{{.HOSTS | default "all"}}'
      DEBUG: '{{.DEBUG | default "false"}}'
      OS_TYPE: '{{.OS_TYPE | default "auto"}}'
    cmds:
      - |
        if [ "{{.OS_TYPE}}" = "windows" ]; then
          {{if eq .DEBUG "false"}}ANSIBLE_PYTHON_INTERPRETER=auto_silent {{end}}\
            ansible {{.HOSTS}} -i "{{.INVENTORY}}" -m win_ping
          exit $?
        elif [ "{{.OS_TYPE}}" = "linux" ]; then
          {{if eq .DEBUG "false"}}ANSIBLE_PYTHON_INTERPRETER=auto_silent {{end}}\
            ansible {{.HOSTS}} -i "{{.INVENTORY}}" -m ping
          exit $?
        fi

        PLAYBOOK=$(mktemp /tmp/ping_playbook.XXXXXX.yml 2>/dev/null || mktemp -t ping_playbook).yml
        cat > "$PLAYBOOK" << 'EOF'
        ---
        - hosts: {{.HOSTS}}
          gather_facts: yes
          tasks:
            - name: Ping Windows hosts
              win_ping:
              when: ansible_facts.os_family == 'Windows'
            - name: Ping macOS hosts
              ping:
              when: ansible_facts['system'] == 'Darwin'
            - name: Ping Linux hosts
              ping:
              when: ansible_facts['system'] == 'Linux'
        EOF
        {{if eq .DEBUG "false"}}ANSIBLE_PYTHON_INTERPRETER=auto_silent {{end}}\
          ansible-playbook -i "{{.INVENTORY}}" "$PLAYBOOK"
        RET=$?
        rm -f "$PLAYBOOK"
        exit $RET

  run-molecule-action:
    desc: Run GitHub Actions molecule workflow using act
    vars:
      ROLE: '{{.ROLE | default ""}}'
      PLAYBOOK: '{{.PLAYBOOK | default ""}}'
      IS_MAC_ARM: '{{if and (eq OS "Darwin") (eq ARCH "arm64")}}true{{else}}false{{end}}'
      ARCH_FLAG: '{{if eq .IS_MAC_ARM "true"}}--container-architecture linux/amd64{{end}}'
    cmds:
      - docker rm -f $(docker ps -q -f name=act-Molecule-Test) 2>/dev/null || true
      - |
        if [ -n "{{.ROLE}}" ]; then
          echo '{"inputs":{"ROLE":"{{.ROLE}}"}}' > /tmp/github-event.json
          act -W .github/workflows/molecule.yaml {{.ARCH_FLAG}} -e /tmp/github-event.json
          rm /tmp/github-event.json
        elif [ -n "{{.PLAYBOOK}}" ]; then
          echo '{"inputs":{"PLAYBOOK":"{{.PLAYBOOK}}"}}' > /tmp/github-event.json
          act -W .github/workflows/molecule.yaml {{.ARCH_FLAG}} -e /tmp/github-event.json
          rm /tmp/github-event.json
        else
          act -W .github/workflows/molecule.yaml {{.ARCH_FLAG}}
        fi

  run-molecule-tests:
    desc: Run molecule tests for roles that have scenarios
    vars:
      ROLES: '{{.ROLES | default "*"}}'
    cmds:
      - cmd: |
          mkdir -p logs
          export ANSIBLE_CONFIG=$(pwd)/ansible.cfg
          export ALLOW_BROKEN_CONDITIONALS=1
          set +e
          ROLES_INPUT="{{.ROLES}}"
          passed_roles=()
          failed_roles=()
          skipped_roles=()

          if [[ "$ROLES_INPUT" == "*" ]] || [[ -z "$ROLES_INPUT" ]]; then
            for role in roles/*; do
              if [[ -d "$role" && -f "$role/molecule/default/molecule.yml" ]]; then
                role_name=$(basename "$role")
                (cd "$role" && molecule test) | tee -a logs/molecule_tests_${role_name}.log
                role_status=${PIPESTATUS[0]}
                if [[ $role_status -eq 0 ]]; then
                  passed_roles+=("$role_name")
                else
                  failed_roles+=("$role_name")
                fi
              elif [[ -d "$role" ]]; then
                skipped_roles+=("$(basename "$role")")
              fi
            done
          else
            echo "$ROLES_INPUT" | tr ',' '\n' | while IFS= read -r role_name; do
              role_name=$(echo "$role_name" | xargs)
              role_path="roles/${role_name}"
              if [[ ! -d "$role_path" ]]; then
                echo "ERROR: Role directory not found: $role_path"
                exit 1
              fi
              if [[ ! -f "$role_path/molecule/default/molecule.yml" ]]; then
                echo "Skipping ${role_name}: no molecule scenario"
                skipped_roles+=("$role_name")
                continue
              fi
              (cd "$role_path" && molecule test) | tee -a logs/molecule_tests_${role_name}.log
              role_status=${PIPESTATUS[0]}
              if [[ $role_status -eq 0 ]]; then
                passed_roles+=("$role_name")
              else
                failed_roles+=("$role_name")
              fi
            done
          fi

          echo ""
          echo "Molecule results:"
          if [[ ${#passed_roles[@]} -gt 0 ]]; then
            echo "  PASS: ${passed_roles[*]}"
          fi
          if [[ ${#failed_roles[@]} -gt 0 ]]; then
            echo "  FAIL: ${failed_roles[*]}"
          fi
          if [[ ${#skipped_roles[@]} -gt 0 ]]; then
            echo "  SKIP: ${skipped_roles[*]}"
          fi

          if [[ ${#failed_roles[@]} -gt 0 ]]; then
            exit 1
          fi
        shell: bash

  update-galaxy-version:
    desc: Update version in galaxy.yml
    preconditions:
      - sh: '[ -n "$NEXT_VERSION" ]'
        msg: "NEXT_VERSION environment variable not set"
      - sh: test -f galaxy.yml
        msg: "galaxy.yml not found"
    cmds:
      - yq e -i '.version = env(NEXT_VERSION)' galaxy.yml
